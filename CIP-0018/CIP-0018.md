---
CIP: 18
Title: Multi Stake Keys Wallets 
Authors: Matthias Benkort <matthias.benkort@iohk.io>
Comments-Summary: Support for multiple stake keys in Cardano wallets.
Comments-URI: https://github.com/cardano-foundation/CIPs/wiki/Comments:CIP-0018
Status: Draft
Type: Standards
Created: 2020-03-18
License: CC-BY-4.0
---


# Multi-stake Keys Wallets

# Abstract

This document describes how to evolve sequential wallets from Cardano to support multiple stake keys. This proposal is an extension of [CIP-1852] and [CIP-0011].

# Motivation / Use-cases

Cardano wallets originally approached stake delegation by considering a single stake keys per wallet. While this was beneficial in terms of ease of implementation and simplicity of reasoning, this is unsuitable for many users with large stakes. Indeed, the inability to split out the stake into multiple pools often leads to over-saturation of existing pools in case of delegation. The only work-around so far requires users to split their funds into multiple accounts and manage them independently. This can be quite cumbersome for a sufficiently large number of accounts. 

Even for smaller actors, it can be interesting to delegate to multiple pools to limit risks. Pools may underperform or simply change their parameters from a day to another (for which wallets still to not warn users about). Delegating to more pools can reduce the impact of pool failure (for one or more epochs) or unattended changes in pool fees. It may as well be a matter of choice if users do want to delegate to several independent entities for various other reasons.

Another concern regards privacy leaks coming with the existing wallet scheme. Since a same stake key is associated to every single address of the wallet, it creates a kind of watermark that allows for tracing all funds belonging to a same wallet very easily (it suffices to look at the stake part of addresses). By allowing the wallet to hold multiple stake keys, rotating through them when creating changes does make the traceability a bit harder. One could imagine using a hundred of stake keys delegated to the same pool.

# Specification

### Overview

The restriction from [CIP-0011] regarding the derivation index reserved for stake key is rendered obsolete by this specification. That is, one is allowed to derive indexes beyond the first one (index = 0) to effectively administrate multi-stake keys accounts. The creation of new stake keys is however tightly coupled to the registration of associated stake keys to allow wallet software 
to automatically discover stake keys on chain. In this design, stake key indexes form *at all time* a contiguous sequence with no gap.

### Key registration

The derivation of new stake keys should abide by the following rules:

- **1.A)** Stake keys must be derived sequentially, from 0 and onwards.
- **1.B)** Except for the first stake key (index = 0), stake keys should be registered before being used in output addresses.

The registration of stake keys beyond the first must satisfy one of the following conditions:

- **2.A)** It must exist an active<sup><a href="#1-active-stake-key">1</a></sup> stake key registration certificate on chain of the immediately previous stake key, located in the stable area<sup><a href="#2-stable-area">2</a></sup> of the chain. 
- **2.B)** It must exist another stake key registration certificate of the immediately previous stake key in the same transaction which satisfies 2.A or 2.B.

Said differently, one can only register a new stake key if previous keys have already been registered and are immutable. We also allow registering keys in batch to alleviate the user experience for users wanting to register many stake keys.

> **For example**, If a slot 10, a wallet registers a stake key at index = 0. At slot 255500, the wallet registers keys from index = 1 to index = 10 in the same transaction. This is fine because the key registration at index 0 can be considered _stable_ and _immutable_ (it's part of all possible chain forks) and the next 10 keys are registered as part of a single transaction. 

Note that the condition 1.B) is only a best-effort to prevent so-called mangled addresses<sup><a href="#3-mangled-addresses">3</a></sup>. It is possible for a key registration to be rolled back, and for an address used later to point to a non-existing key (from the perspective of the main chain). We acknowledge this limitation under the assumption that users or wallets would eventually re-submit any rolled back registration (which are retro-active). 

However, the condition 2.A) is a hard limitation for the good functioning of this specification for it enforces the invariant stated in introduction: 

> **(invariant)** At all time, the key indexes must form a contiguous sequence with no gap. 

This invariant makes it possible for wallets to know when they should generate and look for new stake keys indexes. It allows for efficient implementations both in terms of space and computational cost. Without waiting for stabilisation of certificates, some intermediate certificate may get lost in translation because of chain forks / rollbacks. By ensuring that any previous certificate is active and stable, we ensure that the associated part of the HD tree (that is for an account `i` `1852'/1815'/i'/2/*`) can be recovered fully from the chain at a later time; it requires however a linear scan of the chain.

### Key de-registration

Similarly, keys can only be de-registered in sequence, from the latest and downwards. Transaction de-registering stake keys must satisfy one of the following conditions to be valid:

- **3.A)** The index of the de-registered key must be equal to the index of the last active<sup><a href="#1-active-stake-key">1</a></sup> stake key on chain.
- **3.B)** There exists another stake key de-registration certificate of the immediately next stake key in the same transaction which satisfies 3.A or 3.B.

Note that none of these constraints prevent from re-delegating to a different pool with a stake key that isn't the last one (delegation choices can be changed for any stake key). However, only the last stake key of the sequence can be de-registered. In a similar fashion to the case of registrations, we also allow de-registering keys in batches, so long as all de-registrations are contiguous ordered, and part of the same transaction. 

# Rationale

- Keeping derivation sequential and contiguous makes it possible (and relatively easy) to administrate keys on a HD wallet

- By allowing keys to be registered in batch, we alleviate the pain that could come from waiting between several registrations. With the current network parameters, a transaction may contain more than 400 key registration certificates without reaching the maximum transaction size limit (16 KB). This should cover most use-cases w.r.t multi-delegation.
  
# Backwards Compatibility

As stated in introduction, this proposals is built on top of [CIP-0011] such that backward compatibility is preserved when a single key is used. We do assume that existing wallets following [CIP-0011] are already fully capable to discovering addresses using stake keys not belonging to the wallet. Some may even report them as mangled<sup><a href="#3-mangled-addresses">3</a></sup>. This extension would therefore not incapacitate existing wallets for the payment ownership is left untouched. However, wallets not supporting the extension may display addresses delegated to keys beyond the first one as mangled and may also fail to report rewards correctly across multiple keys. 

We deem this to be an acceptable and fairly minor consequence but encourage existing software to raise awareness about this behavior.

# Glossary

#### 1 - Active stake key

A stake key is considered active if the most recent (in terms of slot number) certificates present on chain is a registration certificate of that stake key. 

#### 2 - Stable area

The stable area of the chain refers to the area considered immutable according to the consensus rules from the Ouroboros protocol in vigor. Since Shelley and the introduction of Ouroboros
Praos, the **unstable** area of the chain is of length `3k / f` slots where `k` and `f` are genesis parameters known respectively as _security parameter_ and _active slot coefficient_. In Shelley, Allegra and Mary, it means that any block that is at least 129600 slots (36h) away from the network tip is considered stable. 

#### 3 - Mangled addresses

An address is said _mangled_ when it has a stake part, and the stake part isn't recognized as belonging to its associated wallet. That is, the payment part and the stake part appear to come from two different sources. This could be the case if the address has been purposely constructed in such a way (because the stake rights and funds are managed by separate entities), or because the stake part refers to a key hash which is no longer known of the wallet (because the associated key registration was rolled back). 

# Reference Implementation

Coming soon.

# Copyright

CC-BY-4.0

[CIP-1852]: https://github.com/cardano-foundation/CIPs/blob/master/CIP-1852/CIP-1852.md
[CIP-0011]: https://github.com/cardano-foundation/CIPs/blob/master/CIP-0011/CIP-0011.md
